# typed: false
# frozen_string_literal: true

# This file was generated by Homebrew. Please do not edit it directly.
class DeltaCli < Formula
  desc "Offline AI Assistant powered by llama.cpp"
  homepage "https://github.com/nile-agi/delta"
  license "MIT"
  
  # Use pre-built binaries - no git, no cloning, no building
  version "1.0.0"
  
  on_macos do
    if Hardware::CPU.arm?
      url "https://github.com/nile-agi/delta/releases/download/v#{version}/delta-cli-macos-arm64.tar.gz"
      sha256 :no_check  # TODO: Update with actual SHA256 when release is available
    else
      url "https://github.com/nile-agi/delta/releases/download/v#{version}/delta-cli-macos-x86_64.tar.gz"
      sha256 :no_check  # TODO: Update with actual SHA256 when release is available
    end
  end

  on_linux do
    if Hardware::CPU.arm?
      url "https://github.com/nile-agi/delta/releases/download/v#{version}/delta-cli-linux-aarch64.tar.gz"
      sha256 :no_check  # TODO: Update with actual SHA256 when release is available
    else
      url "https://github.com/nile-agi/delta/releases/download/v#{version}/delta-cli-linux-x86_64.tar.gz"
      sha256 :no_check  # TODO: Update with actual SHA256 when release is available
    end
  end

  def install
    # Extract pre-built binaries - no git, no cloning, no building required
    # The tarball structure should be: delta-cli-{version}/delta, delta-cli-{version}/delta-server
    if Dir.exist?("delta-cli-#{version}")
      bin.install "delta-cli-#{version}/delta" => "delta"
      bin.install "delta-cli-#{version}/delta-server" => "delta-server"
      
      # Install web UI if present in the tarball
      if Dir.exist?("delta-cli-#{version}/webui")
        share.install "delta-cli-#{version}/webui" => "delta-cli/webui"
      end
    else
      # Fallback: try to find binaries in root of tarball
      bin.install "delta" if File.exist?("delta")
      bin.install "delta-server" if File.exist?("delta-server")
    end
  end

  def post_install
    # Ensure Homebrew bin comes first in PATH to avoid conflicts with llvm's delta
    shell = ENV["SHELL"] || "/bin/zsh"
    shell_config = if shell.include?("zsh")
      File.expand_path("~/.zshrc")
    elsif shell.include?("bash")
      File.expand_path("~/.bash_profile")
    else
      nil
    end
    
    if shell_config && File.exist?(shell_config)
      # Check if PATH fix already exists
      path_fix = '# Delta CLI PATH fix - ensure Homebrew bin comes first'
      unless File.read(shell_config).include?(path_fix)
        File.open(shell_config, "a") do |f|
          f.puts "\n#{path_fix}"
          f.puts 'export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$(echo $PATH | tr ":" "\n" | grep -v "^/opt/homebrew/bin$" | grep -v "^/opt/homebrew/sbin$" | tr "\n" ":" | sed "s/:$//")"'
          f.puts 'alias delta="/opt/homebrew/bin/delta"  # Delta CLI alias to override llvm delta'
        end
        ohai "Added PATH configuration to #{shell_config}"
        ohai "Run 'source #{shell_config}' or restart your terminal to use 'delta' command"
      end
    end
    
    # Also create alias as backup
    ohai "Delta CLI installed successfully!"
    ohai "To use 'delta' command, run: source #{shell_config}" if shell_config
    ohai "Or use full path: /opt/homebrew/bin/delta"
  end

  test do
    system "#{bin}/delta", "--version"
  end
end
